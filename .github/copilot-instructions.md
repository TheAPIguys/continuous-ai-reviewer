# Copilot Instructions for Continuous AI Reviewer

## Project Overview

This VS Code extension automatically monitors Git repositories for new commits and generates AI-powered code reviews. It watches for changes, determines which files were modified between commits, and produces human- and machine-readable review files at `review/review.md`. The extension is designed for future integration with GitHub Copilot Agents for remote AI analysis.

## Architecture & Key Files

### Core Extension Structure

- `src/extension.ts` - Main entry point; wires OutputChannel, creates Agent and GitWatcher instances
- `src/gitWatcher.ts` - Detects new commits via Git CLI polling; computes changed files between commits
- `src/agent.ts` - Processes changes and generates review files; future Copilot Agent integration point
- `package.json` - Extension manifest with `onStartupFinished` activation
- `dist/extension.js` - Compiled output (generated by esbuild)

### Build System

This project uses a **dual-watch setup** for development:

- **esbuild**: Bundles TypeScript to `dist/extension.js` with Node.js CJS format
- **TypeScript compiler**: Type-checks without emitting files (`--noEmit`)
- Both run concurrently via the `watch` task (default build task)

## Development Workflows

### Essential Commands

```bash
# Start development (runs both watchers)
pnpm run watch

# Type check only
pnpm run check-types

# Full build with linting
pnpm run compile

# Package for production
pnpm run package
```

### VS Code Integration

- Press `F5` to launch Extension Development Host with your extension
- The launch configuration auto-runs the default build task before debugging
- Extension activates automatically on startup (`onStartupFinished`)
- Check "Continuous AI Reviewer" output channel for logs and debug info

### Testing

- Tests use `@vscode/test-electron` for VS Code environment testing
- Run `pnpm test` to compile extension and run test suite in ephemeral VS Code
- Test files compile to `out/` directory (separate from main bundle)
- Unit tests for Agent file-writing, integration tests for full commitâ†’review flow

## Core Components Architecture

### GitWatcher (`src/gitWatcher.ts`)

- Polls `git rev-parse HEAD` to detect new commits
- Uses `git diff --name-only <old> <new>` for changed file lists
- Calls `Agent.processChanges(files, oldHash, newHash)` asynchronously
- Must implement Disposable interface for timer cleanup

### Agent (`src/agent.ts`)

- Current: Local stub writing `review/review.md` with timestamp and file list
- Create a chat with Copilot Agent endpoint in future. Request the review and write to `review/review.md`
- Create a command pallette command manual to allow the user to selected default AI model to use with the Agent.

### Extension Lifecycle Pattern

```typescript
// Extension activates on startup, not commands
export function activate(context: vscode.ExtensionContext) {
  const outputChannel = vscode.window.createOutputChannel(
    "Continuous AI Reviewer"
  );
  const agent = new Agent(outputChannel);
  const gitWatcher = new GitWatcher(workspaceRoot, agent, outputChannel);

  context.subscriptions.push(gitWatcher, outputChannel);
}
```

### ESLint Rules

- Use `camelCase` or `PascalCase` for imports
- Always use semicolons
- Prefer `===` over `==`
- Curly braces required for all blocks

### TypeScript Configuration

- Target: ES2022 with Node16 modules
- Strict type checking enabled
- Source maps enabled for development

## Project Structure Decisions

### Why esbuild + TypeScript?

- **esbuild**: Fast bundling, external vscode API, CJS output for Node.js compatibility
- **tsc**: Type checking only (no emission), watches for instant feedback
- **Separation**: Allows independent type checking and bundling processes

### External Dependencies

- `vscode` is marked as external in esbuild (provided by VS Code runtime)
- All dependencies are devDependencies since this bundles to a single file

## Key Integration Points

### VS Code Extension API

- Extension activates on startup (`onStartupFinished` activation event)
- Uses OutputChannel for logging to "Continuous AI Reviewer" panel
- Future: SecretStorage for secure credential management
- Main bundle expects to export `activate` and `deactivate` functions

### Build Problem Matchers

- `$esbuild-watch` and `$tsc-watch` integrated in tasks
- Custom esbuild plugin formats errors for VS Code Problems panel

## Development Notes

### Design Contracts

**Inputs**: Workspace root path, commit range (oldHash, newHash), changed file paths
**Outputs**: Generated `review/review.md` file, logs to OutputChannel
**Error Handling**:

- No Git repo: Extension idles with logged message
- Git CLI failures: Log and continue polling
- Agent failures: Log error, implement retry/backoff

### Edge Cases

- Large diffs: Limit content size sent to remote agents
- Private repos: Use VS Code SecretStorage for credentials
- Multi-root workspaces: Currently uses first workspace folder

### When Adding Dependencies

- Runtime deps should be bundled (add to esbuild, not marked external)
- VS Code API types come from `@types/vscode`
- Keep bundle size minimal for extension performance

### Testing Strategy

- Extension tests run in VS Code environment
- Use `@vscode/test-electron` for E2E testing
- Mock VS Code APIs when possible for unit tests
