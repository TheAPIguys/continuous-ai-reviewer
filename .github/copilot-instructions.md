# Copilot Instructions for Continuous AI Reviewer

## Project Overview

This VS Code extension automatically monitors Git repositories for new commits and generates AI-powered code reviews using the **VS Code Language Model API (`vscode.lm`)**. It watches for changes, determines which files were modified between commits, and produces AI-generated review files at `review/review.md`. The extension integrates directly with GitHub Copilot through the official Language Model API.

## Architecture & Key Files

### Core Extension Structure

- `src/extension.ts` - Main entry point; registers commands, creates Agent and GitWatcher instances
- `src/gitWatcher.ts` - Detects new commits via Git CLI polling (5s interval); computes changed files between commits
- `src/agent.ts` - Generates AI reviews using `vscode.lm` Language Model API; writes `review/review.md`
- `src/providers/` - Legacy provider pattern (deprecated); `IReviewProvider`, `copilotExtensionProvider` not actively used
- `package.json` - Extension manifest with 4 commands: `openReview`, `cRV`, `selectModel`, `generateReviewNow`
- `dist/extension.js` - Compiled output (generated by esbuild)

### Build System

This project uses a **dual-watch setup** for development:

- **esbuild**: Bundles TypeScript to `dist/extension.js` with Node.js CJS format
- **TypeScript compiler**: Type-checks without emitting files (`--noEmit`)
- Both run concurrently via the `watch` task (default build task)

## Development Workflows

### Essential Commands

```bash
# Start development (runs both watchers)
pnpm run watch

# Type check only
pnpm run check-types

# Full build with linting
pnpm run compile

# Package for production
pnpm run package
```

### VS Code Integration

- Press `F5` to launch Extension Development Host with your extension
- The launch configuration auto-runs the default build task before debugging
- Extension activates automatically on startup (`onStartupFinished`)
- Check "Continuous AI Reviewer" output channel for logs and debug info

### Testing

- Tests use `@vscode/test-electron` for VS Code environment testing
- Run `pnpm test` to compile extension and run test suite in ephemeral VS Code
- Test files compile to `out/` directory (separate from main bundle)
- Unit tests for Agent file-writing, integration tests for full commit→review flow

### CI/CD

- **GitHub Actions**: `.github/workflows/ci.yml` runs on every push/PR to master
- **Triggers**: Push to master branch and pull requests targeting master
- **Steps**: Install deps → Type check → Lint → Run tests
- **Environment**: Ubuntu with Node.js 24, pnpm caching enabled

## Core Components Architecture

### GitWatcher (`src/gitWatcher.ts`)

- Polls `git rev-parse HEAD` every 5 seconds to detect new commits
- Uses `git diff --name-only <old> <new>` for changed file lists
- Calls `Agent.processChanges(files, oldHash, newHash)` asynchronously on new commits
- Implements Disposable interface for timer cleanup; logs to "Continuous AI Reviewer" output channel

### Agent (`src/agent.ts`)

**Current Implementation (Nov 2025):**

- Uses `vscode.lm.selectChatModels({ vendor, family })` to get Copilot models dynamically
- Reads model preferences from VS Code settings: `continuousAiReviewer.modelVendor/modelFamily`
- Executes `git diff` to get actual code changes, includes in prompt (truncated at 50KB)
- Streams AI response via `model.sendRequest()` with async iteration over `chatResponse.text`
- Falls back to stub review on errors (no consent, quota exceeded, model unavailable)
- Generates structured prompts requesting: Summary, Code Quality, Security, Performance, Suggestions

**Key Methods:**

- `processChanges()` - Main entry point, no longer uses provider pattern
- `generateReviewContent()` - Calls Language Model API directly
- `getGitDiff()` - Executes git diff command via child_process
- `buildReviewPrompt()` - Constructs structured prompt with diff and file list

### Registered Commands

1. **`continuous-ai-reviewer.openReview`** - Opens `review/review.md` in editor
2. **`continuous-ai-reviewer.cRV`** - Shorthand alias for `openReview`
3. **`continuous-ai-reviewer.selectModel`** - Shows QuickPick of available Copilot models (dynamically fetched from `vscode.lm`)
4. **`continuous-ai-reviewer.generateReviewNow`** - Manually triggers review for HEAD~1→HEAD (useful for debugging)

### Model Selection Architecture

The `selectModel` command dynamically discovers available models:

```typescript
const models = await vscode.lm.selectChatModels({ vendor: currentVendor });
// Deduplicates by family, groups non-premium first, then premium (o1-preview, o1-mini)
// Shows: version, maxInputTokens, current selection indicator
// Saves to global settings: continuousAiReviewer.modelFamily
```

### Extension Lifecycle Pattern

```typescript
export async function activate(context: vscode.ExtensionContext) {
  const outputChannel = vscode.window.createOutputChannel(
    "Continuous AI Reviewer"
  );
  // Legacy: tryCreateCopilotProvider (deprecated, not used)
  const agent = new Agent(workspaceRoot, outputChannel, provider, notifier);
  const gitWatcher = new GitWatcher(workspaceRoot, agent, outputChannel);
  // Register 4 commands, push disposables
}
```

### ESLint Rules

- Use `camelCase` or `PascalCase` for imports
- Always use semicolons
- Prefer `===` over `==`
- Curly braces required for all blocks

### TypeScript Configuration

- Target: ES2022 with Node16 modules
- Strict type checking enabled
- Source maps enabled for development

## Project Structure Decisions

### Why esbuild + TypeScript?

- **esbuild**: Fast bundling, external vscode API, CJS output for Node.js compatibility
- **tsc**: Type checking only (no emission), watches for instant feedback
- **Separation**: Allows independent type checking and bundling processes

### External Dependencies

- `vscode` is marked as external in esbuild (provided by VS Code runtime)
- All dependencies are devDependencies since this bundles to a single file

## Key Integration Points

### VS Code Extension API Usage

**Language Model API (Primary Integration):**

- `vscode.lm.selectChatModels()` - Fetches available Copilot models with filters
- `model.sendRequest(messages, {}, token)` - Sends chat request with cancellation support
- `vscode.LanguageModelChatMessage.User(prompt)` - Constructs user message
- Async iteration: `for await (const fragment of chatResponse.text)` to stream response

**Other VS Code APIs:**

- `vscode.window.createOutputChannel()` - Logging to "Continuous AI Reviewer" panel
- `vscode.workspace.getConfiguration()` - Read/write extension settings
- `vscode.commands.registerCommand()` - Register 4 commands
- `vscode.window.showQuickPick()` - Model selection UI with separators and icons
- Extension activates on `onStartupFinished` (not on command)

### Build Problem Matchers

- `$esbuild-watch` and `$tsc-watch` integrated in tasks.json
- Custom esbuild plugin formats errors for VS Code Problems panel
- Background tasks: `watch:esbuild` and `watch:tsc` run in parallel

## Development Notes

### Design Contracts

**Inputs**: Workspace root path, commit range (oldHash, newHash), changed file paths
**Outputs**: Generated `review/review.md` file, logs to OutputChannel, user notifications
**Error Handling**:

- No Git repo: Extension idles with logged message, no polling
- Git CLI failures: Log and continue polling (non-fatal)
- Language Model errors: Catch `LanguageModelError`, check error.message for "consent"/"quota"
- Falls back to stub review with instructions on enabling Copilot

### Current Implementation Patterns

**Dynamic Model Discovery (not hard-coded):**

```typescript
// DON'T use hard-coded model lists - models change frequently
// DO fetch dynamically from vscode.lm API
const models = await vscode.lm.selectChatModels({ vendor: "copilot" });
// Deduplicate by family, show version + maxInputTokens
```

**Error Logging Pattern:**

```typescript
this.outputChannel.appendLine("[Agent] Step description");
// Always prefix logs with [Component] for filtering
// Show output channel on manual command: outputChannel.show(true)
```

**Provider Pattern (Deprecated):**

- `src/providers/copilotExtensionProvider.ts` exists but is NOT used in main flow
- `Agent.processChanges()` calls `generateReviewContent()` directly (no provider check)
- Keep for backward compatibility but prefer `vscode.lm` API

### Edge Cases

- Large diffs: Truncated at 50KB in `buildReviewPrompt()` to prevent token overflow
- Multi-root workspaces: Uses first workspace folder only (`workspaceFolders[0]`)
- No models available: Shows warning, graceful degradation to stub review
- User consent not given: Specific error message prompts user to grant permission

### When Adding Dependencies

- Runtime deps should be bundled (add to esbuild, not marked external)
- VS Code API types come from `@types/vscode`
- Keep bundle size minimal for extension performance

### Testing Strategy

- Extension tests run in VS Code environment using `@vscode/test-electron`
- Test files in `src/test/unit/` and `src/test/integration/`
- Unit tests compile to `out/` directory (separate from `dist/` bundle)
- Run tests: `pnpm test` (compiles + runs in ephemeral VS Code instance)
- Mock pattern: Agent accepts `Notifier` interface to avoid requiring `vscode` module in tests
- Dynamic `require("vscode")` in Agent allows tests to run outside VS Code environment

### Debugging Tips

**View Extension Logs:**

1. Open Output panel: `View` → `Output` or `Ctrl+Shift+U`
2. Select "Continuous AI Reviewer" from dropdown
3. Look for `[Agent]`, `[Extension]`, `[GitWatcher]` prefixed messages

**Manual Testing:**

- Use `Generate Review Now` command to test without waiting for commits
- Press `F5` to launch Extension Development Host
- Check for Language Model consent prompts on first use
- Model selection shows real-time data from Copilot (not hard-coded)

**Common Issues:**

- Review generated but no AI content → Check if provider was used instead of vscode.lm
- "No models available" → User not signed into Copilot or consent not given
- Empty review → Check output channel for LanguageModelError details
